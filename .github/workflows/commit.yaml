name: Update Chart.yaml

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-chart:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Modify Chart.yaml
        run: |
          echo "${{ github.sha }}" > commit.txt

      - name: Commit Changes Using GraphQL API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |      
          gh api graphql -f query='mutation ($input: CreateCommitOnBranchInput!) {
            createCommitOnBranch(input: $input) { 
              commit { 
                url 
              } 
            } 
          }' \
          --input - <(jq -n --arg repoName '${{ github.repository }}' \
                --arg branchName '${{ github.ref_name }}' \
                --arg expectedHeadOid '${{ github.sha }}' \
                --arg path 'commit.txt' \
                --arg contents '$(cat commit.txt | base64 -w 0)' \
                --arg headline 'Update Chart.yaml' \
          '{
            branch: {
              repositoryNameWithOwner: $repoName,
              branchName: $branchName
            },
            expectedHeadOid: $expectedHeadOid,
            message: {
              headline: $headline
            },
            fileChanges: {
              additions: [
                {
                  path: $path,
                  contents: $contents
                }
              ]
            }
          }')
