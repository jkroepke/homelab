---
storage:
  files:
    - path: "/opt/bin/kubectl"
      filesystem: root
      mode: 0755
      contents:
        remote:
          url: "https://dl.k8s.io/v${version}/bin/linux/arm64/kubectl"
    - path: "/opt/bin/kubelet"
      filesystem: root
      mode: 0755
      contents:
        remote:
          url: "https://dl.k8s.io/v${version}/bin/linux/arm64/kubelet"
    - path: "/etc/default/kubelet"
      filesystem: root
      mode: 0644
      contents:
        inline: >-
          KUBELET_EXTRA_ARGS=
          --container-runtime=remote
          --container-runtime-endpoint=unix:///run/containerd/containerd.sock

systemd:
  units:
    - name: "kubelet.service"
      enabled: true
      #https://raw.githubusercontent.com/kubernetes/release/master/cmd/kubepkg/templates/latest/rpm/kubelet/kubelet.service
      contents: |
        [Unit]
        Description=kubelet: The Kubernetes Node Agent
        Documentation=https://kubernetes.io/docs/
        Wants=network-online.target
        After=network-online.target
        
        [Service]
        ExecStart=/usr/bin/kubelet
        Restart=always
        StartLimitInterval=0
        RestartSec=10
        
        [Install]
        WantedBy=multi-user.target
      dropins:
        - name: 10-kubeadm.conf
          contents: |
            # Note: This dropin only works with kubeadm and kubelet v1.11+
            [Service]
            Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/var/lib/kubelet/kubeconfig"
            Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
            # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
            # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
            EnvironmentFile=/etc/default/kubelet
            ExecStart=
            ExecStart=/opt/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_EXTRA_ARGS
